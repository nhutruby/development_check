(function(d){var b={hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",searchDelay:300,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",tokenDelimiter:",",preventDuplicates:false,prePopulate:null,animateDropdown:true,onResult:null,onAdd:null,onDelete:null};var e={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"};var c={BEFORE:0,AFTER:1,END:2};var a={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188};d.fn.tokenInput=function(h,f){var g=d.extend({},b,f||{});return this.each(function(){new d.TokenList(this,h,g)})};d.TokenList=function(w,H,J){if(d.type(H)==="string"){J.url=H;if(J.crossDomain===undefined){if(J.url.indexOf("://")===-1){J.crossDomain=false}else{J.crossDomain=(location.href.split(/\/+/g)[1]!==J.url.split(/\/+/g)[1])}}}else{if(d.type(H)==="array"){J.local_data=H}}if(J.classes){J.classes=d.extend({},e,J.classes)}else{if(J.theme){J.classes={};d.each(e,function(N,O){J.classes[N]=O+"-"+J.theme})}else{J.classes=e}}var i=[];var n=0;var z=new d.TokenList.Cache();var u;var o;var E=d('<input type="text"  autocomplete="off">').css({outline:"none"}).focus(function(){if(J.tokenLimit===null||J.tokenLimit!==n){L()}}).blur(function(){x()}).bind("keyup keydown blur update",y).keydown(function(O){var Q;var N;switch(O.keyCode){case a.LEFT:case a.RIGHT:case a.UP:case a.DOWN:if(!d(this).val()){Q=t.prev();N=t.next();if((Q.length&&Q.get(0)===p)||(N.length&&N.get(0)===p)){if(O.keyCode===a.LEFT||O.keyCode===a.UP){K(d(p),c.BEFORE)}else{K(d(p),c.AFTER)}}else{if((O.keyCode===a.LEFT||O.keyCode===a.UP)&&Q.length){F(d(Q.get(0)))}else{if((O.keyCode===a.RIGHT||O.keyCode===a.DOWN)&&N.length){F(d(N.get(0)))}}}}else{var P=null;if(O.keyCode===a.DOWN||O.keyCode===a.RIGHT){P=d(g).next()}else{P=d(g).prev()}if(P.length){q(P)}return false}break;case a.BACKSPACE:Q=t.prev();if(!d(this).val().length){if(p){m(d(p))}else{if(Q.length){F(d(Q.get(0)))}}return false}else{if(d(this).val().length===1){x()}else{setTimeout(function(){I()},5)}}break;case a.TAB:case a.ENTER:case a.NUMPAD_ENTER:case a.COMMA:if(g){f(d(g));return false}break;case a.ESCAPE:x();return true;default:if(String.fromCharCode(O.which)){setTimeout(function(){I()},5)}break}});var M=d(w).hide().val("").focus(function(){E.focus()}).blur(function(){E.blur()});var p=null;var g=null;var j=d("<ul />").addClass(J.classes.tokenList).click(function(O){var N=d(O.target).closest("li");if(N&&N.get(0)&&d.data(N.get(0),"tokeninput")){r(N)}else{if(p){K(d(p),c.END)}E.focus()}}).mouseover(function(O){var N=d(O.target).closest("li");if(N&&p!==this){N.addClass(J.classes.highlightedToken)}}).mouseout(function(O){var N=d(O.target).closest("li");if(N&&p!==this){N.removeClass(J.classes.highlightedToken)}}).insertBefore(M);var t=d("<li />").addClass(J.classes.inputToken).appendTo(j).append(E);var G=d("<div>").addClass(J.classes.dropdown).appendTo("body").hide();var h=d("<tester/>").insertAfter(E).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:E.css("fontSize"),fontFamily:E.css("fontFamily"),fontWeight:E.css("fontWeight"),letterSpacing:E.css("letterSpacing"),whiteSpace:"nowrap"});M.val("");li_data=J.prePopulate||M.data("pre");if(li_data&&li_data.length){d.each(li_data,function(N,O){B(O.id,O.name)})}function y(){if(o===(o=E.val())){return}var N=o.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");h.html(N);E.width(h.width()+30)}function l(N){return((N>=48&&N<=90)||(N>=96&&N<=111)||(N>=186&&N<=192)||(N>=219&&N<=222))}function B(R,O){var Q=d("<li><p>"+O+"</p> </li>").addClass(J.classes.token).insertBefore(t);d("<span>"+J.deleteText+"</span>").addClass(J.classes.tokenDelete).appendTo(Q).click(function(){m(d(this).parent());return false});var P={id:R,name:O};d.data(Q.get(0),"tokeninput",P);i.push(P);var N=d.map(i,function(S){return S.id});M.val(N.join(J.tokenDelimiter));n+=1;return Q}function f(N){var Q=d.data(N.get(0),"tokeninput");var P=J.onAdd;if(n>0&&J.preventDuplicates){var O=null;j.children().each(function(){var S=d(this);var R=d.data(S.get(0),"tokeninput");if(R&&R.id===Q.id){O=S;return false}});if(O){F(O);t.insertAfter(O);E.focus();return}}B(Q.id,Q.name);if(J.tokenLimit!==null&&n>=J.tokenLimit){E.hide();x();return}else{E.focus()}E.val("");x();if(d.isFunction(P)){P(Q)}}function F(N){N.addClass(J.classes.selectedToken);p=N.get(0);E.val("");x()}function K(O,N){O.removeClass(J.classes.selectedToken);p=null;if(N===c.BEFORE){t.insertBefore(O)}else{if(N===c.AFTER){t.insertAfter(O)}else{t.appendTo(j)}}E.focus()}function r(O){var N=p;if(p){K(d(p),c.END)}if(N===O.get(0)){K(O,c.END)}else{F(O)}}function m(O){var P=d.data(O.get(0),"tokeninput");var Q=J.onDelete;O.remove();p=null;E.focus();i=d.grep(i,function(R){return(R.id!==P.id)});var N=d.map(i,function(R){return R.id});M.val(N.join(J.tokenDelimiter));n-=1;if(J.tokenLimit!==null){E.show().val("").focus()}if(d.isFunction(Q)){Q(P)}}function x(){G.hide().empty();g=null}function D(){G.css({position:"absolute",top:d(j).offset().top+d(j).outerHeight(),left:d(j).offset().left,zindex:999}).show()}function k(){if(J.searchingText){G.html("<p>"+J.searchingText+"</p>");D()}}function L(){if(J.hintText){G.html("<p>"+J.hintText+"</p>");D()}}function v(O,N){return O.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+N+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")}function C(P,N){if(N&&N.length){G.empty();var O=d("<ul>").appendTo(G).mouseover(function(Q){q(d(Q.target).closest("li"))}).mousedown(function(Q){f(d(Q.target).closest("li"));return false}).hide();d.each(N,function(Q,R){var S=d("<li>"+v(R.name,P)+"</li>").appendTo(O);if(Q%2){S.addClass(J.classes.dropdownItem)}else{S.addClass(J.classes.dropdownItem2)}if(Q===0){q(S)}d.data(S.get(0),"tokeninput",{id:R.id,name:R.name})});D();if(J.animateDropdown){O.slideDown("fast")}else{O.show()}}else{if(J.noResultsText){G.html("<p>"+J.noResultsText+"</p>");D()}}}function q(N){if(N){if(g){s(d(g))}N.addClass(J.classes.selectedDropdownItem);g=N.get(0)}}function s(N){N.removeClass(J.classes.selectedDropdownItem);g=null}function I(){var N=E.val().toLowerCase();if(N&&N.length){if(p){K(d(p),c.AFTER)}if(N.length>=J.minChars){k();clearTimeout(u);u=setTimeout(function(){A(N)},J.searchDelay)}else{x()}}}function A(R){var N=z.get(R);if(N){C(R,N)}else{if(J.url){var P={};P.data={};if(J.url.indexOf("?")>-1){var S=J.url.split("?");P.url=S[0];var O=S[1].split("&");d.each(O,function(T,V){var U=V.split("=");P.data[U[0]]=U[1]})}else{P.url=J.url}P.data[J.queryParam]=R;P.type=J.method;P.dataType=J.contentType;if(J.crossDomain){P.dataType="jsonp"}P.success=function(T){if(d.isFunction(J.onResult)){T=J.onResult.call(this,T)}z.add(R,J.jsonContainer?T[J.jsonContainer]:T);if(E.val().toLowerCase()===R){C(R,J.jsonContainer?T[J.jsonContainer]:T)}};d.ajax(P)}else{if(J.local_data){var Q=d.grep(J.local_data,function(T){return T.name.toLowerCase().indexOf(R.toLowerCase())>-1});C(R,Q)}}}}};d.TokenList.Cache=function(g){var i=d.extend({max_size:500},g);var j={};var h=0;var f=function(){j={};h=0};this.add=function(l,k){if(h>i.max_size){f()}if(!j[l]){h+=1}j[l]=k};this.get=function(k){return j[k]}}}(jQuery));